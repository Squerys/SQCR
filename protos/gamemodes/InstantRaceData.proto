syntax = "proto3";

import "Options.proto";
import "LogicScene.proto";
import "PenaltySystem.proto";
import "Scene.proto";
import "Gameplay.proto";

message InstantRace {
    message SessionPhasePair {
        SessionPhase phase = 1;
        TranslatedTimestamp end_timestamp = 2;
        bool is_set = 4;
    }
    
    message SessionPhaseData {
        repeated SessionPhasePair session_phase_pairs = 1;
        SessionPhase current_phase = 2;
        double current_gamemode_time = 3;
        double start_gamemode_time = 4;
    }
    
    message State {
        message Game {
            PlatformRaceLeaderboard leaderboard = 1;
            SessionPhaseData session_data = 2;
            
            ReadyToStartMap ready_to_start_map = 3;
            message ReadyToStartMap {
                repeated Item items = 1;
                message Item {
                    PGUID car_id = 1;
                    bool value = 2;
                }
            }
            
            PlatformRacePenaltyCollection penalty_collection = 4;
            UnlockCarTime unlock_car_time = 5;
            double start_game_mode_time = 7;
            int32 elimination_remain = 8;
            RealtimeLeaderboard realtime_leaderboard = 9;
            RealtimePositions realtime_positions = 10;
            
            CrossedSafetCarLine crossed_safety_car_map = 11;
            message CrossedSafetCarLine {
                repeated Item items = 1;
                message Item {
                    PGUID car_id = 1;
                    bool value = 2;
                }
            }
            
            TrackStatus track_status = 12;
            message TrackStatus {
                PitSemaphore pitexit_semaphore = 1;
                enum PitSemaphore {
                    Off = 0;
                    Green = 1;
                    Red = 2;
                    Yellow = 3;
                }
            }
            
            ReadyToNextMap ready_to_next_map = 13;
            message ReadyToNextMap {
                repeated Item items = 1;
                message Item {
                    PGUID car_id = 1;
                    bool value = 2;
                }
            }
            
            string name = 1000;
            float finish_line_npos = 14;
        }
        
        message GameCar {
            Investigations investigations = 1;
            message Investigations {
                repeated InvestigationType types = 1;
            }
            
            float last_split_timestamp = 2;
            float time_to_recover = 3;
            bool inside_pit_box = 4;
        }
    }
    
    message Specialization {
        bool proto_options = 666;
        
        Base base = 200;
        message Base {
            uint32 countdown_time_ms = 27;
            uint32 countdown_random_min_time_ms = 28;
            uint32 countdown_random_max_time_ms = 29;
            uint32 session_duration_ms = 4;
            uint32 session_laps = 5;
            uint32 session_minimum_car_count = 7;
            uint32 maximum_waiting_for_players_duration_ms = 8;
            uint32 minimum_waiting_for_players_duration_ms = 9;
            uint32 maximum_session_waiting_for_leader_duration_ms = 15;
            uint32 maximum_session_overtime_duration_ms = 10;
            uint32 maximum_go_to_box_duration_ms = 14;
            uint32 maximum_session_overtime_before_next_session = 20;
            
            StartMode start_mode = 40;
            enum StartMode {
                Grid = 0;
                RollingStartSingleLine = 1;
                RollingStartDoubleLine = 2;
                RollingStartSingleLineDoubleLine = 3;
                RollingStartDoubleLineSingleLine = 4;
            }
            
            uint32 starting_position = 41;
            bool waiting_for_players = 42;
            bool intro_music = 16;
            bool end_music = 17;
            EndReplayType end_replay_type = 18;
            
            reserved 11, 12, 13;
        }
        
        string base_file = 201;
        DataSourceType base_source = 202;
        PenaltyTransformations penalty_transformations = 21;
        string penalty_transformations_file = 23;
        DataSourceType penalty_transformations_source = 25;
        PenaltyInvestigations penalty_investigations = 22;
        string penalty_investigations_file = 24;
        DataSourceType penalty_investigations_source = 26;
        
        repeated Rule rules = 100;
        message Rule {
            oneof type {
                EliminationRule elimination_rule = 54;
                LapTimingAtSessionStart lap_timing_at_session_start = 55;
            }
            
            reserved 51, 52;
        }
        
        repeated string allowed_car_table_keys = 30;
        repeated string allowed_car_keys = 31;
        
        reserved 27, 28, 29, 4, 5, 7, 8, 9, 10, 1, 2, 20;
        
        message EliminationRule {
            EliminationType elimination_type = 1;
            enum EliminationType {
                None = 0;
                By_Laps_Leader = 1;
                By_Laps_Last = 2;
                By_Time = 3;
            }
            
            uint32 elimination_begin = 2;
            uint32 elimination_frequency = 3;
        }
        
        message LapTimingAtSessionStart {
            
        }
        
        enum EndReplayType {
            None = 0;
            Standard = 1;
            Highlights = 2;
            Delayed = 3;
        }
    }
    
    message Command {
        message SessionInitialization {
            RaceTimingTimelineConfig timeline_config = 1;
            repeated ZoneData timelines = 2;
        }
        
        message AddZoneData {
            repeated ZoneData zones = 1;
        }
        
        message ConnectionLoaded {
            PGUID car_id = 1;
        }
        
        message UpdateGamemodeTime {
            double current_session_time_ms = 1;
            bool running = 2;
        }
    }
    
    enum SessionPhase {
        Waiting_For_Players = 0;
        Start_Spawn_On_Position = 1;
        Start_Countdown_No_Lights = 2;
        Start_Countdown_Lights_On = 3;
        Start_Countdown_Lights_Off = 4;
        RollingStart_Start_Formation = 11;
        RollingStart_Change_Line = 12;
        RollingStart_Start_Green_Flag = 13;
        RollingStart_End_Green_Flag = 14;
        Session = 50;
        Overtime_Waiting_For_Leader = 60;
        Overtime_Waiting_For_Others = 70;
        Waiting_For_Ai = 71;
        Waiting_For_PitBox = 72;
        Ended = 80;
        Request_Quit = 90;
    }
}

message InstantRaceUiData {
    bool hide_lap_panel = 1;
    bool hide_gamemode_panel = 2;
    bool hide_result_panel = 3;
    bool hide_realtime_panel = 4;
    bool hide_session_panel = 5;
    bool hide_starting_lights_panel = 6;
    bool hide_ready_panel = 7;
    bool hide_control_panel = 8;
    bool hide_leaderboard_panel = 10;
}
