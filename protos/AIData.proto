syntax = "proto3";

import "Math.proto";
import "CarBehaviour.proto";
import "LogicScene.proto";

message TrackPartData {
    PGUID id = 1;
    
    Type type = 2;
    enum Type {
        Straight = 0;
        PreApex = 1;
        PostApex = 2;
    }
    
    Vector3Data world_pos_start = 3;
    Vector3Data world_pos_end = 4;
    float spline_pos_start = 5;
    float spline_pos_end = 6;
    float push_multiplier = 7;
    float length_meters = 8;
}

message TrackSectionData {
    string display_name = 1;
    repeated TrackPartData track_parts = 2;
}

message TrackSections {
    repeated TrackSectionData data = 1;
}

message TrackControlPointData {
    Vector3Data ideal_line_position = 1;
    Vector3Data forward_vector = 2;
    float side_left = 3;
    float side_left_curb = 4;
    float side_right = 5;
    float side_right_curb = 6;
    float side_left_wall = 11;
    float side_right_wall = 12;
    float signed_radius = 7;
    float push_multiplier = 8;
    float length_meters = 9;
    float spline_pos = 10;
    float lookahead_multiplier = 13;
    repeated TrackControlPointTags context_tags = 14;
}

message TrackControlPoints {
    repeated TrackControlPointData control_points = 1;
}

message AISplineGenomeData {
    Vector3Data world_pos = 1;
    float push_multiplier = 2;
    float length_meters = 3;
    float spline_pos = 4;
}

message AISplineGenomes {
    repeated AISplineGenomeData genomes = 1;
}

message AISplinePayloadData {
    float speedMS = 1;
    float radius = 2;
    float sides_0 = 3;
    float sides_1 = 4;
    float sides_with_curbs_0 = 24;
    float sides_with_curbs_1 = 25;
    float boundaries_0 = 5;
    float boundaries_1 = 6;
    float camber = 7;
    float direction = 8;
    Vector3Data normal = 9;
    Vector3Data forwardVector = 10;
    float length = 11;
    float gas = 12;
    float brake = 13;
    float grade = 14;
    float grip = 15;
    float distFromCorner = 16;
    float distFromNextCorner = 17;
    bool isPitlane = 18;
    float compression = 19;
    float puddle = 20;
    CornerSectionDef cornerSection = 21;
    float walls_0 = 22;
    float walls_1 = 23;
    float radius_change_rate = 26;
}

message AISplineData {
    InterpolatingSplineData spline_data = 1;
    repeated AISplinePayloadData payloads = 2;
    float straight_factor = 3;
    repeated AISplineGenomeData genomes = 4;
    string layout_path = 5;
    float recorded_half_car_width = 6;
    TrackControlPoints control_points = 7;
    SceneTrackInfo track_info = 8;
}

message AIStateData {
    PGUID car_id = 1;
    bool is_player_controlled = 2;
    Vector3Data world_pos = 3;
    Vector3Data car_direction = 4;
    float engine_rpm = 5;
    float steer = 6;
    float gas = 7;
    float brake = 8;
    float clutch = 9;
    int32 gear = 10;
    float speed = 11;
    Vector3Data velocity = 12;
    Vector3Data local_velocity = 13;
    Vector3Data local_angular_velocity = 14;
    Vector3Data angular_velocity = 15;
    repeated float slip_angle = 16;
    repeated float slip_ratio = 17;
    repeated float tyre_slip = 18;
    repeated float nd_slip = 19;
    repeated float nd_slip_smooth = 20;
    repeated float load = 21;
    Vector3Data acc_g = 22;
    float normalized_spline_position = 23;
    float spline_lateral_offset = 24;
    int32 limiter_rpm = 25;
    float fuel = 26;
    float fuel_laps = 27;
    bool is_retired = 28;
    CarStance stance = 29;
    float current_steer_signal = 30;
    Vector3Data steer_target = 31;
    int32 attack_state = 32;
    bool is_active = 33;
    float target_speed = 34;
    float target_lateral_offset = 35;
    float brake_target_speed = 36;
    float brake_target_dist = 37;
    float current_normalized_spline_position = 38;
    float outside_offset = 39;
    float proj_dn_rpm = 40;
    float understeer_factor = 41;
    float current_push = 42;
    float current_radius = 43;
    bool is_brake_target_an_obstacle = 44;
}

message AISplineReferenceDataPayload {
    float spline_position = 1;
    double reference_laptime = 2;
    float reference_speed_ms = 3;
    int32 signed_radius = 4;
    float camber = 5;
    float push_multiplier = 6;
    float calculated_uncapped_speed_ms = 7;
    float acc_z_raw = 8;
    float acc_z_effective = 9;
    float energy_consumption_per_second = 10;
    float energy_consumed = 11;
}

message AISplineReferenceData {
    repeated AISplineReferenceDataPayload payloads = 1;
    bool is_closed = 2;
    float track_meters = 4;
    int32 reference_laptime = 5;
    
    reserved 3;
}

message AiDebugUiData {
    bool show_ai_state_window_open = 2;
    bool show_record_ai_stuff_open = 3;
    bool show_driving_performance = 4;
    bool show_spline_adjustments = 5;
    bool show_debug_splines = 6;
    bool show_spline_sections = 7;
    bool show_engagement_window = 8;
    bool show_opponents_window = 9;
    bool show_rain_stuff = 10;
    bool show_target_speed_window = 11;
    bool show_driver_list = 12;
    bool show_spline_creation_window = 13;
    bool show_steering_stuff_window = 14;
    
    reserved 30, 31;
}

message AiDebugUiNextData {
    bool show_target_spline_window = 1;
    bool show_minispline_window = 2;
    bool show_opponent_tactics_window = 3;
    bool show_ai_replay_data_window = 4;
    bool show_ai_corridor_window = 5;
    bool show_desired_acceleration_window = 6;
}

message TrackControlPointInsertCommand {
    int32 insert_at_index = 1;
    float spline_pos = 2;
}

message TrackControlPointRemoveCommand {
    int32 remove_index = 1;
}

message UpdateMergedPitlaneSplineCommand {
    repeated Vector3Data new_points = 1;
    bool is_start = 4;
    
    reserved 2, 3;
}

message AITrackFinetuning {
    string track_name = 1;
    string track_layout_name = 2;
    bool use_hotstint_containers = 3;
    repeated string car_names = 5;
    repeated int32 push_values = 6;
    repeated int32 grip_values = 7;
    
    ProcessSteps CurrentStep = 8;
    enum ProcessSteps {
        Process_Undefined = 0;
        Process_CreateControlPoints = 1;
        Process_EvaluateLookahead = 10;
        Process_EvaluatePush = 11;
    }
    
    repeated ApexDefinition apex_defs = 9;
    message ApexDefinition {
        int32 controlPointIndex = 1;
        float controlPointSplinePos = 2;
        int32 radius = 3;
        bool is_slowest_point = 4;
    }
    
    repeated EvalResult EvaluationResults = 10;
    message EvalResult {
        string car_name = 1;
        int32 push_value = 2;
        int32 grip_value = 3;
        repeated ApexEvaluation apex_evals = 4;
    }
    
    message ApexEvaluation {
        int32 controlPointIndex = 1;
        float velocity = 2;
        float target_velocity = 3;
        float maxSlip = 4;
        float latG = 5;
        float pushTarget = 6;
        float current_brake_hint = 7;
        float apex_offset = 10;
        float apex_trajectory_error = 11;
        float current_push_mult = 12;
        float current_lookahead_factor = 13;
        float current_car_push_adjustment = 14;
        float current_car_apex_push_adjustment = 15;
    }
}

message AISplineAccuracy {
    message Sequence {
        float spline_pos_start = 1;
        float spline_pos_end = 2;
        double start_time_ms = 3;
        double end_time_ms = 4;
        OffsetErrorState error_state = 5;
        float start_error = 6;
        float avg_error = 7;
        float peak_error = 8;
        float end_error = 9;
        float error_sum = 10;
        int32 error_count = 11;
        repeated float error_values = 12;
        repeated Vector3Data world_positions = 13;
        int32 next_controlpoint_index = 14;
    }
    
    message Result {
        ResultType result_type = 1;
        double start_time_ms = 2;
        double end_time_ms = 3;
        int32 step_count = 4;
        float total_squared_error = 5;
        float meters_driven = 6;
        bool started_on_track_spline = 7;
        repeated Sequence sequences = 8;
    }
    
    enum ResultType {
        Undefined = 0;
        Testset = 1;
        Lap = 2;
        Section = 3;
        Corner = 4;
    }
    
    enum OffsetErrorState {
        Unknown = 0;
        OnTarget = 1;
        Inside = 2;
        Outside = 3;
    }
}

enum CornerSectionDef {
    CornerSectionDef_Straight = 0;
    CornerSectionDef_CornerEntry = 1;
    CornerSectionDef_CornerExit = 2;
}

enum TrackControlPointTags {
    ControlPointTag_LongStraight = 0;
    ControlPointTag_Straight = 1;
    ControlPointTag_BrakeZone = 2;
    ControlPointTag_Entry = 3;
    ControlPointTag_Apex = 4;
    ControlPointTag_Slowest_Point = 5;
    ControlPointTag_Exit = 6;
    ControlPointTag_AccelZone = 10;
    ControlPointTag_PitEntry_Start = 11;
    ControlPointTag_PitEntry_End = 12;
    ControlPointTag_PitExit_Line_Start = 13;
    ControlPointTag_PitExit_Line_End = 14;
    ControlPointTag_AutoGenerated_Preprocessing = 100;
    ControlPointTag_AutoGenerated_Runtime = 101;
}
